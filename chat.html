<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Dr. Jenab - Integrative Medicine Specialist</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- OpenAI Configuration -->
    <script src="openai-config.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyASOLTTloSZaXXlqmjHoL-f4zIXRaYoMq0",
            authDomain: "jenabapp.firebaseapp.com",
            projectId: "jenabapp",
            storageBucket: "jenabapp.firebasestorage.app",
            messagingSenderId: "336941312949",
            appId: "1:336941312949:web:207552406203bbd829c7fc",
            measurementId: "G-CMZGSLCFQ9"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOut = signOut;
        window.collection = collection;
        window.addDoc = addDoc;
        window.query = query;
        window.orderBy = orderBy;
        window.onSnapshot = onSnapshot;
        window.serverTimestamp = serverTimestamp;
    </script>
</head>
<body data-theme="light">
    <div class="container">
        <!-- Particle Background -->
        <div class="particles" id="particles"></div>
        
        <!-- Chat Header -->
        <header class="hero" style="margin-bottom: 2rem;">
            <div class="glass-card hero-card" style="padding: 2rem; position: relative;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                    <button onclick="window.location.href='index.html'" class="glass-button" style="padding: 0.5rem 1rem;">
                        ‚Üê Back to Home
                    </button>
                    <button id="logoutBtn" class="glass-button" style="padding: 0.5rem 0.75rem; font-size: 0.8rem; height: auto; min-height: auto; line-height: 1.2; display: inline-flex; align-items: center; gap: 0.25rem;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16,17 21,12 16,7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        Sign Out
                    </button>
                </div>
                <h1 class="hero-title" style="font-size: 2.5rem; margin-bottom: 0.5rem;">Chat with Dr. Jenab</h1>
                <p class="hero-subtitle">Educational health information and guidance</p>
                
            </div>
        </header>

        <!-- Chat Area -->
        <div style="max-width: 800px; margin: 0 auto;">
            <div class="glass-card" style="padding: 0; overflow: hidden; height: 600px; display: flex; flex-direction: column;">
                <!-- Messages -->
                <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem;">
                    <div style="text-align: center; margin-top: 5rem; opacity: 0.7;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 1rem;">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <p>Hello! I'm here to provide educational information about health and wellness.</p>
                        <p style="font-size: 0.875rem; margin-top: 0.5rem;">Ask me anything about naturopathic medicine or integrative health.</p>
                    </div>
                </div>

                <!-- Suggested Questions (show only when chat is empty) -->
                <div id="suggestedQuestions" style="padding: 1rem; border-top: 1px solid var(--glass-border); display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
                    <button class="suggested-question" data-question="What is naturopathic medicine?" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 1rem; padding: 0.5rem 1rem; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; white-space: nowrap;">
                        What is naturopathic medicine?
                    </button>
                    <button class="suggested-question" data-question="How do you approach digestive health?" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 1rem; padding: 0.5rem 1rem; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; white-space: nowrap;">
                        How do you approach digestive health?
                    </button>
                    <button class="suggested-question" data-question="What integrative treatments do you offer?" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 1rem; padding: 0.5rem 1rem; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; white-space: nowrap;">
                        What integrative treatments do you offer?
                    </button>
                    <button class="suggested-question" data-question="Tell me about your philosophy on chronic conditions" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 1rem; padding: 0.5rem 1rem; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; white-space: nowrap;">
                        Tell me about your philosophy on chronic conditions
                    </button>
                </div>

                <!-- Input Area -->
                <div style="border-top: 1px solid var(--glass-border); padding: 1rem;">
                    <form id="chatForm" style="display: flex; gap: 0.75rem;">
                        <input
                            type="text"
                            id="chatInput"
                            placeholder="Ask about health and wellness..."
                            style="flex: 1; background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 0.75rem; padding: 0.75rem 1rem; font-size: 1rem; outline: none;"
                        />
                        <button
                            type="submit"
                            class="glass-button"
                            style="padding: 0.75rem 1.5rem;"
                        >
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Bottom Section: Disclaimer and Appointment -->
        <div style="max-width: 800px; margin: 2rem auto 0; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <!-- Medical Disclaimer -->
            <div class="glass-card" style="padding: 1rem; background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.2);">
                <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #f59e0b; margin-top: 0.25rem; flex-shrink: 0;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <div style="font-size: 0.8rem;">
                        <p style="font-weight: 600; margin-bottom: 0.25rem;">Important Medical Disclaimer</p>
                        <p>This chat provides educational information only and does not constitute medical advice, diagnosis, or treatment. Always consult with Dr. Jenab or qualified healthcare providers for personal medical concerns.</p>
                    </div>
                </div>
            </div>

            <!-- Book Appointment -->
            <div class="glass-card" style="padding: 1rem; text-align: center; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2);">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin: 0 auto 0.5rem; color: #3b82f6;">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <h3 style="font-weight: 600; margin-bottom: 0.5rem; font-size: 1rem;">Need Personal Care?</h3>
                <p style="font-size: 0.8rem; margin-bottom: 1rem; opacity: 0.8;">Schedule an appointment for personalized medical advice</p>
                <a
                    href="https://www.ucihealth.org/find-a-doctor/j/arvin-jenab"
                    target="_blank"
                    class="glass-button"
                    style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1rem; font-size: 0.8rem;"
                >
                    Book Appointment
                </a>
            </div>
        </div>
    </div>

    <script>
        // Firebase Auth & Chat functionality
        document.addEventListener('DOMContentLoaded', () => {
            const initializeChat = () => {
                if (!window.firebaseAuth) {
                    setTimeout(initializeChat, 100);
                    return;
                }

                const auth = window.firebaseAuth;
                const db = window.firebaseDb;
                const chatForm = document.getElementById('chatForm');
                const chatInput = document.getElementById('chatInput');
                const chatMessages = document.getElementById('chatMessages');
                const suggestedQuestions = document.querySelectorAll('.suggested-question');

                // Check authentication state - support both Firebase and localStorage fallback
                console.log('üîç Chat page: Checking authentication state...');
                
                // Check localStorage first (for local development fallback)
                const localAuth = localStorage.getItem('userSignedIn') === 'true';
                const localUser = localStorage.getItem('userName') || 'Test User';
                const localEmail = localStorage.getItem('userEmail') || 'test@example.com';
                
                console.log('üìã LocalStorage auth:', localAuth, 'User:', localUser);
                
                if (localAuth) {
                    // Use localStorage auth for local development
                    console.log('‚úÖ Using localStorage authentication');
                    const mockUser = {
                        displayName: localUser,
                        email: localEmail,
                        uid: 'local-user-' + Date.now()
                    };
                    setupChat(mockUser);
                    return;
                }
                
                // Fallback to Firebase auth
                window.onAuthStateChanged(auth, (user) => {
                    console.log('üî• Firebase auth state changed:', user ? user.email : 'No user');
                    
                    if (!user && !localAuth) {
                        // No authentication at all, redirect to home
                        console.log('‚ùå No authentication found, redirecting to home');
                        window.location.href = 'index.html';
                        return;
                    }
                    
                    if (user) {
                        // Firebase user authenticated
                        console.log('‚úÖ Firebase user authenticated:', user.email);
                        setupChat(user);
                    }
                });

                function setupChat(user) {
                    // Set theme
                    const savedTheme = localStorage.getItem('theme') || 'light';
                    document.body.setAttribute('data-theme', savedTheme);

                    // Initialize particles
                    new ParticleSystem();

                    // Handle logout button
                    const logoutBtn = document.getElementById('logoutBtn');
                    if (logoutBtn) {
                        logoutBtn.addEventListener('click', async () => {
                            console.log('üö™ Logout button clicked');
                            
                            // Add loading state
                            logoutBtn.disabled = true;
                            logoutBtn.innerHTML = `
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M12 6v6l4 2"></path>
                                </svg>
                                Signing out...
                            `;
                            
                            try {
                                // Sign out from Firebase
                                if (window.signOut && auth) {
                                    console.log('üî• Signing out from Firebase...');
                                    await window.signOut(auth);
                                }
                                
                                console.log('üßπ Clearing local storage...');
                                // Clear localStorage and sessionStorage
                                localStorage.clear();
                                sessionStorage.clear();
                                
                                console.log('üè† Redirecting to homepage...');
                                // Redirect to homepage
                                window.location.href = 'index.html';
                                
                            } catch (error) {
                                console.error('Logout error:', error);
                                console.log('üîÑ Force clearing and redirecting...');
                                
                                // Force redirect even if Firebase logout fails
                                localStorage.clear();
                                sessionStorage.clear();
                                window.location.href = 'index.html';
                            }
                        });
                    } else {
                        console.error('‚ùå Logout button not found');
                    }

                    // Handle suggested questions
                    const suggestedQuestionsContainer = document.getElementById('suggestedQuestions');
                    suggestedQuestions.forEach(button => {
                        button.addEventListener('click', () => {
                            const question = button.getAttribute('data-question');
                            chatInput.value = question;
                            // Hide suggested questions after clicking
                            if (suggestedQuestionsContainer) {
                                suggestedQuestionsContainer.style.display = 'none';
                            }
                        });
                        
                        button.addEventListener('mouseenter', () => {
                            button.style.background = 'rgba(255, 255, 255, 0.3)';
                            button.style.transform = 'translateY(-2px)';
                        });
                        
                        button.addEventListener('mouseleave', () => {
                            button.style.background = 'rgba(255, 255, 255, 0.1)';
                            button.style.transform = 'translateY(0)';
                        });
                    });

                    // Handle chat form submission
                    chatForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const message = chatInput.value.trim();
                        if (!message) return;

                        // Disable input while processing
                        chatInput.disabled = true;
                        const submitBtn = chatForm.querySelector('button[type="submit"]');
                        submitBtn.disabled = true;

                        // Hide suggested questions on first message
                        const suggestedQuestionsContainer = document.getElementById('suggestedQuestions');
                        if (suggestedQuestionsContainer) {
                            suggestedQuestionsContainer.style.display = 'none';
                        }

                        // Add user message to UI
                        addMessage(message, 'user', user.displayName || 'You');
                        chatInput.value = '';

                        try {
                            // Save message to Firestore
                            await window.addDoc(window.collection(db, 'chats'), {
                                userId: user.uid,
                                userEmail: user.email,
                                message: message,
                                role: 'user',
                                timestamp: window.serverTimestamp()
                            });

                            // Get AI response from OpenAI
                            try {
                                const aiResponse = await window.callOpenAI([{
                                    role: 'user',
                                    content: message
                                }]);
                                
                                addMessage(aiResponse, 'assistant', 'Dr. Jenab');
                                
                                // Save AI response to Firestore
                                await window.addDoc(window.collection(db, 'chats'), {
                                    userId: user.uid,
                                    userEmail: user.email,
                                    message: aiResponse,
                                    role: 'assistant',
                                    timestamp: window.serverTimestamp()
                                });
                                
                            } catch (error) {
                                console.error('Error getting AI response:', error);
                                // Fallback to placeholder response
                                const fallbackResponse = generatePlaceholderResponse(message);
                                addMessage(fallbackResponse, 'assistant', 'Dr. Jenab');
                                
                                await window.addDoc(window.collection(db, 'chats'), {
                                    userId: user.uid,
                                    userEmail: user.email,
                                    message: fallbackResponse,
                                    role: 'assistant',
                                    timestamp: window.serverTimestamp()
                                });
                            }
                            
                            // Re-enable input
                            chatInput.disabled = false;
                            submitBtn.disabled = false;
                            chatInput.focus();

                        } catch (error) {
                            console.error('Error saving message:', error);
                            alert('Failed to send message. Please try again.');
                            
                            // Re-enable input
                            chatInput.disabled = false;
                            submitBtn.disabled = false;
                        }
                    });
                }

                function generatePlaceholderResponse(userMessage) {
                    const lowerMessage = userMessage.toLowerCase();
                    
                    // Medical advice detection keywords
                    const medicalKeywords = ['diagnose', 'treatment', 'medication', 'pain', 'symptom', 'hurt', 'sick', 'disease', 'condition', 'dose', 'prescription', 'cure', 'therapy', 'what should i take', 'how much', 'when should i', 'is it safe', 'side effects'];
                    const hasmedicalRequest = medicalKeywords.some(keyword => lowerMessage.includes(keyword));
                    
                    if (hasmedicalRequest) {
                        return "I appreciate your question, but as this is an educational platform, I cannot provide specific medical advice, diagnoses, or treatment recommendations. For your health and safety, these matters require a proper medical evaluation. Please schedule an appointment with me at UCI Health by calling (949) 824-7000 or booking online at ucihealth.org. I'm available at our Irvine location (Susan Samueli Integrative Health Institute) and Costa Mesa location. I'd be happy to provide personalized care during a consultation!";
                    }
                    
                    if (lowerMessage.includes('naturopathic') || lowerMessage.includes('naturopath')) {
                        return "Naturopathic medicine focuses on treating the whole person and identifying root causes of illness. As I often say, 'Health is a whole-person experience ‚Äì food, environment, community, and mind all deserve attention.' I combine evidence-based natural therapies with conventional medicine. For educational purposes, what specific aspect of naturopathic care interests you? For personalized care, please schedule a consultation at (949) 824-7000.";
                    }
                    
                    if (lowerMessage.includes('digestive') || lowerMessage.includes('gut') || lowerMessage.includes('stomach')) {
                        return "Digestive health is foundational to overall wellness - I take a comprehensive approach looking at diet, stress, gut microbiome, and underlying inflammation. Many digestive concerns can be addressed through integrative approaches, but this requires proper evaluation. For specific digestive concerns, please schedule an appointment at (949) 824-7000 so I can provide personalized assessment and care.";
                    }
                    
                    if (lowerMessage.includes('chronic') || lowerMessage.includes('fatigue') || lowerMessage.includes('fibromyalgia')) {
                        return "Chronic conditions are one of my clinical specialties. I use a systems-based approach to identify underlying patterns and work to optimize metabolic function and enhance the body's natural resilience. Each treatment plan is highly personalized. For chronic health concerns, I'd recommend scheduling a consultation at (949) 824-7000 where we can thoroughly evaluate your individual situation.";
                    }
                    
                    if (lowerMessage.includes('appointment') || lowerMessage.includes('schedule') || lowerMessage.includes('book')) {
                        return "I'd be delighted to see you for a consultation! You can schedule an appointment by calling (949) 824-7000 or booking online through the UCI Health portal at ucihealth.org. I see patients at two locations: our Irvine location at the Susan Samueli Integrative Health Institute (856 Health Sciences Rd, Suite 2600) and our Costa Mesa location (1202 Bristol Street, Floor 2). We also offer telehealth consultations when appropriate.";
                    }
                    
                    if (lowerMessage.includes('integrative') || lowerMessage.includes('holistic')) {
                        return "Integrative medicine is at the heart of what I do - combining the best of naturopathic and conventional approaches. As I believe, 'the days of one doctor treating one condition are behind us.' We work as a team to provide whole-person, patient-centered care. This educational chat can provide general information, but for personalized integrative care, please schedule a consultation at (949) 824-7000.";
                    }
                    
                    // Default response with strong medical disclaimer
                    return `Thank you for your question about "${userMessage}". This chat provides educational information only and cannot replace proper medical evaluation. While I'm passionate about patient education and empowerment, specific health concerns require personalized assessment. Please schedule a consultation at UCI Health by calling (949) 824-7000 or booking online at ucihealth.org. I'm here to provide comprehensive, integrative care when we can meet properly!`;
                }

                function addMessage(content, role, senderName) {
                    const messageDiv = document.createElement('div');
                    messageDiv.style.display = 'flex';
                    messageDiv.style.gap = '0.75rem';
                    messageDiv.style.justifyContent = role === 'user' ? 'flex-end' : 'flex-start';
                    messageDiv.style.marginBottom = '1rem';

                    const avatar = document.createElement('div');
                    avatar.style.width = '32px';
                    avatar.style.height = '32px';
                    avatar.style.borderRadius = '50%';
                    avatar.style.background = role === 'user' ? 'var(--glass-bg)' : 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
                    avatar.style.display = 'flex';
                    avatar.style.alignItems = 'center';
                    avatar.style.justifyContent = 'center';
                    avatar.style.flexShrink = '0';
                    avatar.style.color = role === 'user' ? 'var(--text-primary)' : 'white';
                    
                    if (role === 'user') {
                        avatar.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>';
                    } else {
                        avatar.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>';
                    }

                    const messageContent = document.createElement('div');
                    messageContent.style.maxWidth = '80%';
                    messageContent.style.borderRadius = '1rem';
                    messageContent.style.padding = '1rem';
                    messageContent.style.background = role === 'user' ? 'var(--glass-bg)' : 'rgba(59, 130, 246, 0.1)';
                    messageContent.style.border = role === 'user' ? '1px solid var(--glass-border)' : '1px solid rgba(59, 130, 246, 0.2)';
                    messageContent.style.whiteSpace = 'pre-wrap';
                    messageContent.style.lineHeight = '1.5';
                    
                    // Add sender name
                    if (senderName) {
                        const nameSpan = document.createElement('div');
                        nameSpan.style.fontSize = '0.75rem';
                        nameSpan.style.fontWeight = '600';
                        nameSpan.style.marginBottom = '0.25rem';
                        nameSpan.style.opacity = '0.8';
                        nameSpan.textContent = senderName;
                        messageContent.appendChild(nameSpan);
                    }
                    
                    const textDiv = document.createElement('div');
                    textDiv.textContent = content;
                    messageContent.appendChild(textDiv);

                    if (role === 'user') {
                        messageDiv.appendChild(messageContent);
                        messageDiv.appendChild(avatar);
                    } else {
                        messageDiv.appendChild(avatar);
                        messageDiv.appendChild(messageContent);
                    }

                    // Clear welcome message if it exists
                    const welcomeMsg = chatMessages.querySelector('div[style*="text-align: center"]');
                    if (welcomeMsg) {
                        welcomeMsg.remove();
                    }

                    chatMessages.appendChild(messageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            };
            
            initializeChat();
        });
    </script>
    <script src="script.js"></script>
</body>
</html>